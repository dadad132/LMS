{% extends "base.html" %}

{% block title %}{{ course.title }} - {{ site_config.site_name if site_config else 'LMS' }}{% endblock %}

{% block content %}
<div class="course-detail">
    <!-- Course Header with Preview Video/Image -->
    <div class="course-header-section">
        <div class="container">
            <div class="course-header-grid">
                <div class="course-header-content">
                    <nav class="breadcrumb">
                        <a href="/">Home</a> / <a href="/courses">Courses</a> / <span>{{ course.title }}</span>
                    </nav>
                    <span class="course-category-badge">{{ course.category or 'General' }}</span>
                    <h1>{{ course.title }}</h1>
                    <p class="course-short-desc">{{ course.short_description or (course.description[:200] + '...' if course.description else '') }}</p>
                    
                    <div class="course-meta">
                        <span class="meta-item"><strong>üìö</strong> {{ course.lessons | length }} lessons</span>
                        <span class="meta-item"><strong>üìä</strong> {{ course.difficulty_level | capitalize }}</span>
                        <span class="meta-item"><strong>üë•</strong> {{ course.enrollments | length }} enrolled</span>
                    </div>
                    
                    <div class="course-actions">
                        {% if current_user %}
                            {% set is_enrolled = current_user.id in course.enrollments | map(attribute='user_id') | list %}
                            {% if is_enrolled %}
                            <a href="#lessons" class="btn btn-primary btn-lg">Continue Learning</a>
                            {% else %}
                            <button id="enrollBtn" class="btn btn-primary btn-lg">
                                Enroll Now - {{ 'Free' if course.is_free else '$' ~ course.price }}
                            </button>
                            {% endif %}
                        {% else %}
                        <a href="/login?next=/course/{{ course.id }}" class="btn btn-primary btn-lg">Login to Enroll</a>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Course Preview Media -->
                <div class="course-preview-media">
                    {% if course.preview_video_url %}
                    <div class="video-wrapper">
                        {% if 'youtube.com' in course.preview_video_url or 'youtu.be' in course.preview_video_url %}
                        <iframe src="{{ course.preview_video_url | replace('watch?v=', 'embed/') | replace('youtu.be/', 'youtube.com/embed/') }}" 
                                frameborder="0" allowfullscreen></iframe>
                        {% elif 'vimeo.com' in course.preview_video_url %}
                        <iframe src="{{ course.preview_video_url | replace('vimeo.com/', 'player.vimeo.com/video/') }}" 
                                frameborder="0" allowfullscreen></iframe>
                        {% else %}
                        <video controls poster="{{ course.thumbnail_url or '' }}">
                            <source src="{{ course.preview_video_url }}" type="video/mp4">
                        </video>
                        {% endif %}
                    </div>
                    {% elif course.thumbnail_url %}
                    <img src="{{ course.thumbnail_url }}" alt="{{ course.title }}" class="course-thumbnail">
                    {% else %}
                    <div class="course-placeholder">
                        <span>üéì</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Course Content -->
    <div class="container">
        <div class="course-layout">
            <!-- Main Content -->
            <div class="course-main">
                <!-- About -->
                <section class="course-section">
                    <h2>About This Course</h2>
                    <div class="course-description">
                        {{ course.description | safe if course.description else 'No description provided.' }}
                    </div>
                </section>
                
                <!-- What You'll Learn -->
                {% if course.learning_outcomes %}
                <section class="course-section">
                    <h2>What You'll Learn</h2>
                    <div class="outcomes-grid">
                        {% for outcome in course.learning_outcomes %}
                        <div class="outcome-item">
                            <span class="outcome-icon">‚úÖ</span>
                            <span>{{ outcome }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </section>
                {% endif %}
                
                <!-- Requirements -->
                {% if course.requirements %}
                <section class="course-section">
                    <h2>Requirements</h2>
                    <ul class="requirements-list">
                        {% for req in course.requirements %}
                        <li>{{ req }}</li>
                        {% endfor %}
                    </ul>
                </section>
                {% endif %}
                
                <!-- Course Content / Lessons -->
                <section class="course-section" id="lessons">
                    <h2>Course Content</h2>
                    <div class="lessons-list" id="lessonsList">
                        <p class="loading">Loading lessons...</p>
                    </div>
                </section>
            </div>
            
            <!-- Sidebar -->
            <div class="course-sidebar">
                <div class="sidebar-card sticky">
                    <h3>This Course Includes</h3>
                    <ul class="course-includes">
                        <li>üìπ <span id="videoCount">0</span> video lessons</li>
                        <li>üìÑ Downloadable resources</li>
                        <li>üì± Access on all devices</li>
                        <li>üèÜ Certificate of completion</li>
                        <li>‚ôæÔ∏è Lifetime access</li>
                    </ul>
                    
                    <div class="sidebar-cta">
                        {% if current_user %}
                        <button id="enrollBtnSidebar" class="btn btn-primary btn-block">
                            Enroll Now
                        </button>
                        {% else %}
                        <a href="/login?next=/course/{{ course.id }}" class="btn btn-primary btn-block">Login to Enroll</a>
                        {% endif %}
                    </div>
                </div>
                
                {% if course.tags %}
                <div class="sidebar-card">
                    <h3>Tags</h3>
                    <div class="tags-list">
                        {% for tag in course.tags %}
                        <a href="/courses?tag={{ tag }}" class="tag">{{ tag }}</a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Lesson Video Modal -->
<div id="lessonModal" class="modal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h3 id="lessonModalTitle">Lesson</h3>
            <button class="modal-close" onclick="closeLessonModal()">&times;</button>
        </div>
        <div class="modal-body" id="lessonModalBody">
            <!-- Content loaded dynamically -->
        </div>
    </div>
</div>

<style>
.course-header-section {
    background: linear-gradient(135deg, var(--header-bg-color), color-mix(in srgb, var(--header-bg-color), black 20%));
    color: var(--header-text-color);
    padding: 3rem 0;
}
.course-header-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 3rem;
    align-items: center;
}
.course-category-badge {
    display: inline-block;
    background: var(--primary-color);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.875rem;
    margin-bottom: 1rem;
}
.course-header-content h1 {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    color: inherit;
}
.course-short-desc {
    font-size: 1.1rem;
    opacity: 0.9;
    margin-bottom: 1.5rem;
}
.course-meta {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
}
.meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.95rem;
}
.course-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}
.course-preview-media {
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
}
.video-wrapper {
    position: relative;
    padding-bottom: 56.25%;
    height: 0;
}
.video-wrapper iframe,
.video-wrapper video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}
.course-thumbnail {
    width: 100%;
    display: block;
}
.course-placeholder {
    background: var(--gray-200);
    padding: 4rem;
    text-align: center;
    font-size: 4rem;
}
.course-layout {
    display: grid;
    grid-template-columns: 1fr 350px;
    gap: 2rem;
    padding: 3rem 0;
}
.course-section {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: var(--shadow);
    margin-bottom: 2rem;
}
.course-section h2 {
    font-size: 1.5rem;
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid var(--gray-100);
}
.outcomes-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
}
.outcome-item {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
}
.sidebar-card {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: var(--shadow);
    margin-bottom: 1.5rem;
}
.sidebar-card.sticky {
    position: sticky;
    top: 100px;
}
.sidebar-card h3 {
    font-size: 1.1rem;
    margin-bottom: 1rem;
}
.course-includes {
    list-style: none;
    padding: 0;
    margin: 0 0 1.5rem 0;
}
.course-includes li {
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--gray-100);
}
.btn-block {
    display: block;
    width: 100%;
    text-align: center;
}
.tags-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}
.tag {
    background: var(--gray-100);
    color: var(--gray-700);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.875rem;
    text-decoration: none;
}
.tag:hover {
    background: var(--primary-color);
    color: white;
}
.lesson-section {
    margin-bottom: 1.5rem;
}
.section-title {
    font-size: 1rem;
    font-weight: 600;
    padding: 1rem;
    background: var(--gray-50);
    border-radius: 8px;
    margin-bottom: 0.5rem;
}
.lesson-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid var(--gray-100);
    cursor: pointer;
    transition: background 0.2s;
}
.lesson-item:hover {
    background: var(--gray-50);
}
.lesson-number {
    width: 30px;
    height: 30px;
    background: var(--gray-200);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    font-weight: 600;
    margin-right: 1rem;
    flex-shrink: 0;
}
.lesson-info {
    flex: 1;
}
.lesson-title {
    display: block;
    font-weight: 500;
}
.lesson-meta {
    display: flex;
    gap: 1rem;
    font-size: 0.875rem;
    color: var(--gray-500);
    margin-top: 0.25rem;
}
.preview-badge {
    background: var(--secondary-color);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
}
.locked {
    color: var(--gray-400);
}
/* Modal */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}
.modal.active {
    display: flex;
}
.modal-content {
    background: white;
    border-radius: 12px;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow: auto;
}
.modal-content.modal-lg {
    max-width: 900px;
}
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--gray-200);
}
.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--gray-500);
}
.modal-body {
    padding: 1.5rem;
}
.modal-body .video-wrapper {
    margin-bottom: 1rem;
}
.lesson-content-text {
    line-height: 1.8;
}
.lesson-attachments {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--gray-200);
}
.lesson-attachments h4 {
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}
.attachment-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: var(--gray-100);
    padding: 0.5rem 1rem;
    border-radius: 4px;
    text-decoration: none;
    color: var(--gray-700);
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
}
.attachment-link:hover {
    background: var(--primary-color);
    color: white;
}
/* Quiz Styles */
.quiz-container {
    padding: 1rem 0;
}
.quiz-header {
    background: var(--gray-50);
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
}
.quiz-question {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: 8px;
    padding: 1.25rem;
    margin-bottom: 1rem;
}
.question-text {
    font-size: 1.05rem;
    margin-bottom: 1rem;
}
.question-options {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}
.option-label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border: 1px solid var(--gray-200);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
}
.option-label:hover {
    background: var(--gray-50);
    border-color: var(--primary-color);
}
.option-label input[type="radio"] {
    width: 18px;
    height: 18px;
}
.option-label input[type="radio"]:checked + span {
    font-weight: 500;
    color: var(--primary-color);
}
.quiz-result {
    text-align: center;
    padding: 2rem;
    border-radius: 12px;
    margin-top: 1rem;
}
.quiz-result.passed {
    background: #d4edda;
    border: 2px solid #28a745;
}
.quiz-result.failed {
    background: #f8d7da;
    border: 2px solid #dc3545;
}
.quiz-result h3 {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
}
/* Progress tracking styles */
.lesson-item.lesson-locked {
    opacity: 0.6;
    cursor: not-allowed;
}
.lesson-item.lesson-completed {
    background: #f0fff4;
}
.lesson-number.completed {
    background: #28a745 !important;
    color: white;
}
.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}
.status-badge.completed {
    background: #d4edda;
    color: #155724;
}
.status-badge.locked {
    background: #f8d7da;
    color: #721c24;
}
.status-badge.available {
    background: var(--primary-color);
    color: white;
}
.mark-complete-section {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--gray-200);
    text-align: center;
}
.mark-complete-section.completed {
    color: #28a745;
    font-weight: 500;
}
.btn-success {
    background: #28a745;
    color: white;
    border: none;
    padding: 0.75rem 2rem;
    font-size: 1rem;
    cursor: pointer;
    border-radius: 8px;
}
.btn-success:hover {
    background: #218838;
}
@media (max-width: 1024px) {
    .course-header-grid {
        grid-template-columns: 1fr;
    }
    .course-layout {
        grid-template-columns: 1fr;
    }
    .sidebar-card.sticky {
        position: static;
    }
}
@media (max-width: 768px) {
    .course-header-content h1 {
        font-size: 1.75rem;
    }
    .outcomes-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block extra_scripts %}
<script>
    const courseId = {{ course.id }};
    const isEnrolled = {{ 'true' if current_user and current_user.id in course.enrollments | map(attribute='user_id') | list else 'false' }};
    let lessonsData = [];
    let progressData = null;
    
    async function loadProgress() {
        if (!isEnrolled) return null;
        try {
            const response = await fetch(`/api/courses/${courseId}/progress`);
            if (response.ok) {
                progressData = await response.json();
                return progressData;
            }
        } catch (e) {
            console.log('Could not load progress');
        }
        return null;
    }
    
    async function loadLessons() {
        try {
            const response = await fetch(`/api/courses/${courseId}/lessons`);
            lessonsData = await response.json();
            
            const container = document.getElementById('lessonsList');
            
            // Count videos
            const videoCount = lessonsData.filter(l => l.content_type === 'video').length;
            document.getElementById('videoCount').textContent = videoCount;
            
            if (lessonsData.length === 0) {
                container.innerHTML = '<p class="text-muted">No lessons available yet.</p>';
                return;
            }
            
            // Group by section
            const sections = {};
            lessonsData.forEach((lesson, index) => {
                const section = lesson.section || 'Course Content';
                if (!sections[section]) {
                    sections[section] = [];
                }
                sections[section].push({ ...lesson, number: index + 1 });
            });
            
            // Load progress if enrolled
            if (isEnrolled) {
                await loadProgress();
            }
            
            container.innerHTML = Object.entries(sections).map(([sectionName, sectionLessons]) => `
                <div class="lesson-section">
                    <h4 class="section-title">${sectionName} (${sectionLessons.length} lessons)</h4>
                    <div class="section-lessons">
                        ${sectionLessons.map(lesson => {
                            const progress = progressData?.lessons?.find(p => p.lesson_id === lesson.id);
                            const isUnlocked = !isEnrolled || !progressData || progress?.is_unlocked;
                            const isCompleted = progress?.is_completed || false;
                            const canAccess = lesson.is_free_preview || (isEnrolled && isUnlocked);
                            
                            let statusBadge = '';
                            if (isEnrolled) {
                                if (isCompleted) {
                                    statusBadge = '<span class="status-badge completed">‚úì Complete</span>';
                                } else if (!isUnlocked) {
                                    statusBadge = '<span class="status-badge locked">üîí Locked</span>';
                                } else {
                                    statusBadge = '<span class="status-badge available">‚ñ∂ Start</span>';
                                }
                            } else if (lesson.is_free_preview) {
                                statusBadge = '<span class="preview-badge">Free Preview</span>';
                            } else {
                                statusBadge = '<span class="locked">üîí</span>';
                            }
                            
                            return `
                            <div class="lesson-item ${canAccess ? 'preview-available' : 'lesson-locked'} ${isCompleted ? 'lesson-completed' : ''}" 
                                 onclick="${canAccess ? `openLesson(${lesson.id})` : `showLockedMessage(${lesson.id})`}">
                                <span class="lesson-number ${isCompleted ? 'completed' : ''}">${isCompleted ? '‚úì' : lesson.number}</span>
                                <div class="lesson-info">
                                    <span class="lesson-title">${lesson.title}</span>
                                    <span class="lesson-meta">
                                        ${lesson.content_type === 'video' ? 'üìπ Video' : lesson.content_type === 'text' ? 'üìÑ Article' : 'üìù Quiz'}
                                        ${lesson.video_duration_minutes ? ' ‚Ä¢ ' + lesson.video_duration_minutes + ' min' : ''}
                                        ${progress?.best_score !== null && progress?.best_score !== undefined ? ' ‚Ä¢ Best: ' + progress.best_score + '%' : ''}
                                    </span>
                                </div>
                                ${statusBadge}
                            </div>
                        `;}).join('')}
                    </div>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading lessons:', error);
            document.getElementById('lessonsList').innerHTML = '<p class="text-muted">Failed to load lessons.</p>';
        }
    }
    
    function openLesson(lessonId) {
        const lesson = lessonsData.find(l => l.id === lessonId);
        if (!lesson) return;
        
        const modal = document.getElementById('lessonModal');
        const modalTitle = document.getElementById('lessonModalTitle');
        const modalBody = document.getElementById('lessonModalBody');
        
        modalTitle.textContent = lesson.title;
        
        let contentHtml = '';
        
        // Video content
        if (lesson.content_type === 'video' && lesson.video_url) {
            const videoUrl = lesson.video_url;
            if (videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be')) {
                let videoId = '';
                if (videoUrl.includes('youtu.be')) {
                    videoId = videoUrl.split('youtu.be/')[1]?.split('?')[0];
                } else {
                    videoId = videoUrl.split('v=')[1]?.split('&')[0];
                }
                contentHtml = `<div class="video-wrapper"><iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe></div>`;
            } else if (videoUrl.includes('vimeo.com')) {
                const vimeoId = videoUrl.split('vimeo.com/')[1]?.split('?')[0];
                contentHtml = `<div class="video-wrapper"><iframe src="https://player.vimeo.com/video/${vimeoId}" frameborder="0" allowfullscreen></iframe></div>`;
            } else {
                // Direct video file (uploaded or external mp4)
                contentHtml = `<div class="video-wrapper"><video controls autoplay><source src="${videoUrl}" type="video/mp4">Your browser does not support the video tag.</video></div>`;
            }
        }
        
        // Quiz content
        if (lesson.content_type === 'quiz' && lesson.quiz_questions && lesson.quiz_questions.length > 0) {
            contentHtml += `<div class="quiz-container">
                <div class="quiz-header">
                    <p>üìù This quiz has <strong>${lesson.quiz_questions.length}</strong> questions. 
                    Passing score: <strong>${lesson.quiz_passing_score || 70}%</strong>
                    ${lesson.quiz_time_limit ? ` ‚Ä¢ Time limit: <strong>${lesson.quiz_time_limit} minutes</strong>` : ''}</p>
                </div>
                <form id="quizForm" onsubmit="submitQuiz(event, ${lesson.id})">
                    ${lesson.quiz_questions.map((q, qi) => `
                        <div class="quiz-question">
                            <p class="question-text"><strong>Q${qi + 1}.</strong> ${q.question}</p>
                            <div class="question-options">
                                ${q.options.map((opt, oi) => `
                                    <label class="option-label">
                                        <input type="radio" name="q${qi}" value="${oi}" required>
                                        <span>${opt}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                    <button type="submit" class="btn btn-primary">Submit Quiz</button>
                </form>
                <div id="quizResult" style="display:none;"></div>
            </div>`;
        }
        
        // Text content
        if (lesson.content) {
            contentHtml += `<div class="lesson-content-text">${lesson.content}</div>`;
        }
        
        // Attachments / Resources
        if (lesson.attachments && lesson.attachments.length > 0) {
            contentHtml += `<div class="lesson-attachments">
                <h4>üìé Downloadable Resources</h4>
                ${lesson.attachments.map(att => {
                    const fileName = att.split('/').pop();
                    const isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(fileName);
                    const isPdf = /\.pdf$/i.test(fileName);
                    const icon = isImage ? 'üñºÔ∏è' : isPdf ? 'üìÑ' : 'üìé';
                    return `<a href="${att}" class="attachment-link" download target="_blank">${icon} ${fileName}</a>`;
                }).join('')}
            </div>`;
        }
        
        if (!contentHtml) {
            contentHtml = '<p>No content available for this lesson.</p>';
        }
        
        // Add Mark Complete button for non-quiz lessons when enrolled
        if (isEnrolled && lesson.content_type !== 'quiz') {
            const progress = progressData?.lessons?.find(p => p.lesson_id === lessonId);
            if (!progress?.is_completed) {
                contentHtml += `<div class="mark-complete-section">
                    <button class="btn btn-success" onclick="markLessonComplete(${lessonId})">
                        ‚úì Mark as Complete
                    </button>
                </div>`;
            } else {
                contentHtml += `<div class="mark-complete-section completed">
                    <span>‚úì You have completed this lesson</span>
                </div>`;
            }
        }
        
        modalBody.innerHTML = contentHtml;
        modal.classList.add('active');
    }
    
    function closeLessonModal() {
        const modal = document.getElementById('lessonModal');
        modal.classList.remove('active');
        // Stop video playback
        document.getElementById('lessonModalBody').innerHTML = '';
    }
    
    // Close modal on backdrop click
    document.getElementById('lessonModal').addEventListener('click', function(e) {
        if (e.target === this) closeLessonModal();
    });
    
    // Escape key to close
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeLessonModal();
    });
    
    // Submit Quiz
    async function submitQuiz(event, lessonId) {
        event.preventDefault();
        const lesson = lessonsData.find(l => l.id === lessonId);
        if (!lesson) return;
        
        const form = document.getElementById('quizForm');
        const formData = new FormData(form);
        const answers = {};
        
        lesson.quiz_questions.forEach((q, qi) => {
            const qId = q.id || qi;
            const answer = formData.get(`q${qi}`);
            answers[qId] = parseInt(answer);
        });
        
        let score = 0;
        let passed = false;
        let serverResult = null;
        
        // Submit to server first to get proper score and save the attempt
        if (isEnrolled) {
            try {
                const response = await fetch(`/api/courses/${courseId}/lessons/${lessonId}/quiz/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ answers })
                });
                if (response.ok) {
                    serverResult = await response.json();
                    score = serverResult.score;
                    passed = serverResult.passed;
                }
            } catch (e) {
                console.log('Could not save quiz attempt:', e);
            }
        }
        
        // If server didn't respond, calculate locally
        if (!serverResult) {
            let correct = 0;
            lesson.quiz_questions.forEach((q, qi) => {
                const qId = q.id || qi;
                if (answers[qId] === q.correct_answer) {
                    correct++;
                }
            });
            score = Math.round((correct / lesson.quiz_questions.length) * 100);
            passed = score >= (lesson.quiz_passing_score || 70);
        }
        
        // Show results
        const resultDiv = document.getElementById('quizResult');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
            <div class="quiz-result ${passed ? 'passed' : 'failed'}">
                <h3>${passed ? 'üéâ Congratulations!' : 'üòî Not Quite'}</h3>
                <p>Your score: <strong>${Math.round(score)}%</strong></p>
                <p>${passed ? '‚úÖ You passed the quiz! This lesson is now complete.' : `‚ùå You need ${lesson.quiz_passing_score || 70}% to pass. Try again!`}</p>
                ${passed ? '<button class="btn btn-success" onclick="closeLessonModal()">Continue Course</button>' : '<button class="btn btn-primary" onclick="resetQuiz()">Try Again</button>'}
            </div>
        `;
        
        // Hide form
        form.style.display = 'none';
        
        // Reload progress and update lesson list if passed
        if (passed && isEnrolled) {
            await loadProgress();
            await loadLessons();
        }
    }
    
    function closeLessonModal() {
        const modal = document.getElementById('lessonModal');
        modal.classList.remove('active');
        // Reload lessons to show updated completion status
        loadLessons();
    }
    
    function resetQuiz() {
        const form = document.getElementById('quizForm');
        const resultDiv = document.getElementById('quizResult');
        form.reset();
        form.style.display = 'block';
        resultDiv.style.display = 'none';
    }
    
    function showLockedMessage(lessonId) {
        const progress = progressData?.lessons?.find(p => p.lesson_id === lessonId);
        if (!progress) {
            alert('Please enroll to access this lesson.');
            return;
        }
        
        // Find blocking lesson
        const allLessons = progressData.lessons;
        const lessonIndex = allLessons.findIndex(l => l.lesson_id === lessonId);
        
        for (let i = 0; i < lessonIndex; i++) {
            const prev = allLessons[i];
            if (!prev.is_completed) {
                if (prev.content_type === 'quiz') {
                    alert(`You must pass the quiz "${prev.title}" with at least ${prev.passing_score}% to unlock this lesson.`);
                } else {
                    alert(`You must complete "${prev.title}" before accessing this lesson.`);
                }
                return;
            }
        }
        alert('Complete previous lessons to unlock this one.');
    }
    
    async function markLessonComplete(lessonId) {
        try {
            const response = await fetch(`/api/courses/${courseId}/lessons/${lessonId}/complete`, {
                method: 'POST'
            });
            if (response.ok) {
                const result = await response.json();
                // Reload progress data and lessons to update UI
                await loadProgress();
                await loadLessons();
                
                // Update the button to show completion
                const markCompleteSection = document.querySelector('.mark-complete-section');
                if (markCompleteSection) {
                    markCompleteSection.innerHTML = '<div class="completed-message">‚úÖ Lesson Complete!</div>';
                    markCompleteSection.classList.add('completed');
                }
            } else {
                const error = await response.json();
                alert(error.detail || 'Could not mark lesson complete');
            }
        } catch (e) {
            console.error('Error:', e);
        }
    }
    
    // Enroll
    async function enroll() {
        try {
            const response = await fetch(`/api/courses/${courseId}/enroll`, {
                method: 'POST'
            });
            
            if (response.ok) {
                alert('Successfully enrolled! You can now access all lessons.');
                window.location.reload();
            } else {
                const error = await response.json();
                alert(error.detail || 'Enrollment failed');
            }
        } catch (error) {
            console.error('Enrollment error:', error);
            alert('An error occurred. Please try again.');
        }
    }
    
    const enrollBtn = document.getElementById('enrollBtn');
    const enrollBtnSidebar = document.getElementById('enrollBtnSidebar');
    
    if (enrollBtn) enrollBtn.addEventListener('click', enroll);
    if (enrollBtnSidebar) enrollBtnSidebar.addEventListener('click', enroll);
    
    // Load lessons
    loadLessons();
</script>
{% endblock %}


